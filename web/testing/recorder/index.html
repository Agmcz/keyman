<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Set the viewport width to match phone and tablet device widths -->
  <meta name="viewport" content="width=device-width,user-scalable=no" />

  <!-- Allow KeymanWeb to be saved to the iPhone home screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Enable IE9 Standards mode -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>KeymanWeb - Test Input Recorder</title>

  <!-- Your page CSS -->
  <style type='text/css'>
    body {
      font-family: Tahoma, helvetica;
    }

    h3 {
      font-size: 1em;
      font-weight: normal;
      color: darkred;
      margin-bottom: 4px
    }

    .test {
      font-size: 1.5em;
      width: 80%;
      min-height: 30px;
      border: 1px solid gray;
    }

    #KeymanWebControl {
      width: 50%;
      min-width: 600px;
    }
  </style>

  <!-- Insert uncompiled KeymanWeb source scripts -->
  <script src="../../release/unminified/web/keymanweb.js" type="application/javascript"></script>

  <!-- 
      For desktop browsers, a script for the user interface must be inserted here.
       
      Standard UIs are toggle, button, float and toolbar.  
      The toolbar UI is best for any page designed to support keyboards for 
      a large number of languages.
    -->
  <script src="../../release/unminified/web/kmwuitoggle.js"></script>

  <script src="keyboardScripts.js" type="application/javascript"></script>

  <script src="build/inputEvents.js" type="application/javascript"></script>

  <!-- Initialization: set paths to keyboards, resources and fonts as required -->
  <script>
    // Thank you to https://stackoverflow.com/questions/22607150/getting-the-url-parameters-inside-the-html-page. 
    var GetURLParameter = function (sParam) {
      var sPageURL = window.location.search.substring(1);
      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++) {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) {
          return sParameterName[1];
        }
      }
    };


    var kmw = window.keyman;
    kmw.init({
      attachType: 'auto',
    });
  </script>

  <script>
    // Time for the magic.  Yay, JavaScript method extension strategies...
    var _kd = keyman.touchAliasing._KeyDown.bind(keyman.touchAliasing);
    keyman.touchAliasing._KeyDown = function(e) {
      var event = new KMWRecorder.PhysicalInputEvent(e);
      // Record the keystroke as part of a test sequence!
      console.log(JSON.stringify(event));
      return _kd(e);
    }

    var _ock = keyman.osk.clickKey.bind(keyman.osk);
    keyman.osk.clickKey = function(e) {
      var event = new KMWRecorder.OSKInputEvent(e);
      // Record the click/touch as part of a test sequence!
      console.log(JSON.stringify(event));
      return _ock(e);
    }

    var _sak = keyman.keyboardManager._SetActiveKeyboard.bind(keyman.keyboardManager);
    keyman.keyboardManager._SetActiveKeyboard = function(PInternalName, PLgCode, saveCookie) {
      _sak(PInternalName, PLgCode, saveCookie);

      // What's the active stub immediately after our _SetActiveKeyboard call?
      var kbdRecord = new KMWRecorder.KeyboardStub(keyman.keyboardManager.activeStub);
      console.log(JSON.stringify(kbdRecord));
    }

  </script>
</head>

<!-- Sample page HTML -->

<body onload='loadKeyboards();'>
  <h2>KeymanWeb - Test Input Recorder</h2>
  <p>This page is designed to record KeymanWeb input for use in testing.</p>
  <hr/>
  <div>
    <input type='text' id='receiver'/>
  </div>
  <hr/>
  <!--  The following elements show how the language menu can be dynamically extended at any time -->
  <h3>Add a keyboard by keyboard name:</h3>
  <input type='input' id='kbd_id1' class='kmw-disabled' onkeypress="clickOnEnter(event,1);"/>
  <input type='button' id='btn1' onclick='addKeyboard(1);' value='Add' />

  <h3>Add a keyboard by ISO 639 language code:</h3>
  <input type='input' id='kbd_id2' class='kmw-disabled' onkeypress="clickOnEnter(event,2);"/>
  <input type='button' id='btn2' onclick='addKeyboard(2);' value='Add' />

  <h3>Add a keyboard by language name:</h3>
  <input type='input' id='kbd_id3' class='kmw-disabled' onkeypress="clickOnEnter(event,3);"/>
  <input type='button' id='btn3' onclick='addKeyboard(3);' value='Add' />   
  <h3>
    <a href="../index.html">Return to testing home page</a>
  </h3>
</body>

</html>